name: Test ghcup action

on:
  push:
  workflow_dispatch:

jobs:
  simple:
    strategy:
      matrix:
        runs-on:
          - ubuntu-latest
          - macos-latest
          - windows-latest
        version:
          - latest
          - '0.1.30.0'
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./ghcup
        with:
          version: ${{ matrix.version }}

      - run: ghcup config
      - run: ghcup debug-info
      - run: ghcup tool-requirements
      - run: ghcup list

      - run: ghcup install ghc latest --set
      - run: ghcup whereis ghc latest
      - run: which ghc
      - run: ghc --version

      - if: ${{ runner.os == 'Windows' }}
        run: ghcup run bash -- -c 'echo yes'
    
  all-tools:
    strategy:
      matrix:
        runs-on:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./ghcup

      - run: ghcup config
      - run: ghcup debug-info
      - run: ghcup tool-requirements
      - run: ghcup list

      - run: ghcup install cabal latest --set
      - run: ghcup whereis cabal latest
      - run: which cabal
      - run: cabal --version
      
      - run: ghcup install stack latest --set
      - run: ghcup whereis stack latest
      - run: which stack
      - run: stack --version
      
      - run: ghcup install hls latest --set
      - run: ghcup whereis hls latest
      - run: which haskell-language-server-wrapper
      - run: haskell-language-server-wrapper --version

  channels:
    strategy:
      matrix:
        runs-on:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./ghcup
        with:
          release-channels: |
            GHCupURL
            https://raw.githubusercontent.com/haskell/ghcup-metadata/refs/heads/develop/ghcup-vanilla-0.0.8.yaml

      - run: ghcup config
      - run: ghcup debug-info
      - run: ghcup tool-requirements
      - run: ghcup list
